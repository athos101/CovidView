<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covid View</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Ícones do Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        
        .row-eq-height {
            display: flex;
            flex-wrap: wrap;
        }
        .card {
            height: 100%;
        }
    </style>
</head>
<body class="bg-light">

    <!-- BARRA DE NAVEGAÇÃO -->
    <nav class="navbar navbar-expand-lg bg-danger-subtle shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-shield-virus"></i>
                Covid Viewer
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
            </div>
        </div>
    </nav>

    <!-- CONTEÚDO PRINCIPAL -->
    <div class="container-fluid p-4">
        <div class="row">

            <!-- CONTEÚDO ESQUERDA -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow">
                    <div class="card-body p-4">
                        <h2 class="card-title mb-3"><i class="bi bi-search"></i> Painel de Busca</h2>
                        <div class="mb-4">
                            <p class="mb-2">Buscar top 10 países com maior % de vacinação (com base na população):</p>
                            <button id="btn_vac" class="btn btn-primary w-100">
                                <i class="bi bi-play-circle-fill"></i> Buscar dados de vacinação
                            </button>
                        </div>
                        <div class="mb-4">
                            <p class="mb-2">Buscar top 10 países com maior % de mortes por Covid (com base na população):</p>
                            <button id="btn_death" class="btn btn-danger w-100">
                                <i class="bi bi-play-circle-fill"></i> Buscar dados de mortes
                            </button>
                        </div>
                        
                        <div id="ordenacao-controls" style="display: none;">
                            <hr>
                            <h3 class="mt-4 fs-5">Opções de Ordenação</h3>
                            <p>Escolha a ordem de exibição dos resultados:</p>
                            <div class="d-grid gap-2" role="group">
                                <button id="btn_decrescente" class="btn btn-success">
                                    <i class="bi bi-sort-down"></i> Maior % primeiro (Padrão)
                                </button>
                                <button id="btn_crescente" class="btn btn-warning">
                                    <i class="bi bi-sort-up"></i> Menor % primeiro
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CONTEÚDO DIREITA -->
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-body p-4">
                         <h2 class="card-title mb-4"><i class="bi bi-bar-chart-line"></i> Resultados</h2>
                         <div id="resultados" class="text-center text-muted">
                            <p>Aguardando busca para exibir os resultados...</p>
                         </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
    google.charts.load('current', {'packages':['corechart']});

    document.getElementById("btn_vac").addEventListener("click", GetVaccineStats);
    document.getElementById("btn_death").addEventListener("click", GetDeathStats);
    document.getElementById("btn_crescente").addEventListener("click", () => {
        if (deathDataLoaded && document.getElementById("resultados").innerHTML.includes("Mortalidade Covid")) {
            ordenarDadosMortes("crescente");
        } else {
            ordenarDados("crescente");
        }
    });
    document.getElementById("btn_decrescente").addEventListener("click", () => {
        if (deathDataLoaded && document.getElementById("resultados").innerHTML.includes("Mortalidade Covid")) {
            ordenarDadosMortes("decrescente");
        } else {
            ordenarDados("decrescente");
        }
    });

    loading = document.createElement("loading");
    loading.innerHTML = `
        <div class="d-flex justify-content-center align-items-center p-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-3 fs-5">Buscando dados...</span>
        </div>`;

    const deathStats = {};
    let tmp = null;
    let deathDataLoaded = false;

    function GetDeathStats() {
        const area = document.getElementById("resultados");
        area.innerHTML = loading.innerHTML;
        if (deathDataLoaded) {
            document.getElementById("ordenacao-controls").style.display = "block";
            adicionarBotaoAgrupamentoMortes();
            ordenarDadosMortes("decrescente");
            return;
        }

        tmp=null;
        fetch("https://restcountries.com/v3.1/all?fields=name,languages,population")
            .then(res => res.json())
            .then(countryData => {
                tmp=countryData;
                const countryMap = {};
                for (let country of countryData) {
                    let valores = {};
                    valores["populacao"] = country.population;
                    let linguas = Object.values(country.languages || {});
                    valores["linguas"] = linguas.map(l => l.toUpperCase());
                    countryMap[country.name.common.toUpperCase()] = valores;
                    if (country.name.official)
                        countryMap[country.name.official.toUpperCase()] = valores;
                }

                return fetch("https://disease.sh/v3/covid-19/countries")
                    .then(res => res.json())
                    .then(deathData => {
                        deathData.forEach(item => {
                            if (item.country.toUpperCase() === "USA") {
                                item.country = "UNITED STATES";
                            }
                            if (item.country.toUpperCase() === "UK") {
                                item.country = "UNITED KINGDOM";
                            }
                        });

                        tmp = deathData;
                        for (let item of deathData) {
                            let countryName = item.country.toUpperCase();
                            let valores = countryMap[countryName];
                            if (!valores && item.countryInfo && item.countryInfo.iso2) {
                                for (let key in countryMap) {
                                    if (key.includes(item.countryInfo.iso2)) {
                                        valores = countryMap[key];
                                        break;
                                    }
                                }
                            }
                            if (valores && valores["populacao"] > 0) {
                                let mortes = item.deaths;
                                valores["mortes"] = mortes;
                                valores["percentual_mortes"] = (mortes / valores["populacao"]) * 100;
                                deathStats[countryName] = valores;
                            }
                        }
                        deathDataLoaded = true;
                        document.getElementById("ordenacao-controls").style.display = "block";
                        adicionarBotaoAgrupamentoMortes();
                        ordenarDadosMortes("decrescente");
                    });
            })
            .catch(error => {
                area.innerHTML = `<div class="alert alert-danger"><strong>Erro ao buscar dados:</strong> ${error.message}</div>`;
            });
    }

    const vaccStats = {};
    let vaccDataLoaded = false;
    let modoAgrupamento = "paises";

    function GetVaccineStats() {
        const area = document.getElementById("resultados");
        area.innerHTML = loading.innerHTML;
        
        if (vaccDataLoaded) {
            document.getElementById("ordenacao-controls").style.display = "block";
            ordenarDados("decrescente");
            return;
        }
        
        fetch("https://restcountries.com/v3.1/all?fields=name,languages,population")
            .then(res => res.json())
            .then(countryData => {
                for (let country of countryData) {
                    let valores = {};
                    valores["populacao"] = country.population;
                    let linguas = Object.values(country.languages || {});
                    valores["linguas"] = linguas.map(l => l.toUpperCase());
                    vaccStats[country.name.common.toUpperCase()] = valores;
                }

                return fetch("https://disease.sh/v3/covid-19/vaccine/coverage/countries?lastdays=1&fullData=true");
            })
            .then(res => res.json())
            .then(vaccineData => {
                for (let item of vaccineData) {
                    let countryName = item.country.toUpperCase();
                    if (countryName in vaccStats) {
                        let vacinas = item.timeline[0].total;
                        vaccStats[countryName]["vacinas"] = vacinas;
                        vaccStats[countryName]["percentual_vacina"] = (vacinas / vaccStats[countryName]["populacao"]) * 100;
                    }
                }
                
                vaccDataLoaded = true;
                document.getElementById("ordenacao-controls").style.display = "block";
                adicionarBotaoAgrupamento();
                ordenarDados("decrescente");
            })
            .catch(error => {
                area.innerHTML = `<div class="alert alert-danger"><strong>Erro ao buscar dados:</strong> ${error.message}</div>`;
            });
    }

    function adicionarBotaoAgrupamento() {
        let controls = document.getElementById("ordenacao-controls");
        // Remove o botão de agrupamento de mortes se estiver presente
        let btnToggleMortes = document.getElementById("btn_toggle_mortes");
        if (btnToggleMortes) {
            btnToggleMortes.remove();
        }

        let btnToggle = document.getElementById("btn_toggle");
        if (!btnToggle) {
            btnToggle = document.createElement("button");
            btnToggle.id = "btn_toggle";
            btnToggle.className = "btn btn-secondary mt-3";
            controls.appendChild(btnToggle);
            btnToggle.addEventListener("click", () => {
                if (modoAgrupamento === "paises") {
                    modoAgrupamento = "linguas";
                    btnToggle.innerHTML = '<i class="bi bi-arrow-left-right"></i> Agrupar por Países';
                } else {
                    modoAgrupamento = "paises";
                    btnToggle.innerHTML = '<i class="bi bi-arrow-left-right"></i> Agrupar por Línguas';
                }
                ordenarDados("decrescente");
            });
        }
        btnToggle.innerHTML = (modoAgrupamento === "paises") ? '<i class="bi bi-arrow-left-right"></i> Agrupar por Línguas' : '<i class="bi bi-arrow-left-right"></i> Agrupar por Países';
    }

    let modoAgrupamentoMortes = "paises";

    function adicionarBotaoAgrupamentoMortes() {
        let controls = document.getElementById("ordenacao-controls");
        // Remove o botão de agrupamento de vacinas se estiver presente
        let btnToggleVacinas = document.getElementById("btn_toggle");
        if (btnToggleVacinas) {
            btnToggleVacinas.remove();
        }

        let btnToggle = document.getElementById("btn_toggle_mortes");
        if (!btnToggle) {
            btnToggle = document.createElement("button");
            btnToggle.id = "btn_toggle_mortes";
            btnToggle.className = "btn btn-secondary mt-3";
            controls.appendChild(btnToggle);
            btnToggle.addEventListener("click", () => {
                if (modoAgrupamentoMortes === "paises") {
                    modoAgrupamentoMortes = "linguas";
                    btnToggle.innerHTML = '<i class="bi bi-arrow-left-right"></i> Agrupar por Países';
                } else {
                    modoAgrupamentoMortes = "paises";
                    btnToggle.innerHTML = '<i class="bi bi-arrow-left-right"></i> Agrupar por Línguas';
                }
                ordenarDadosMortes("decrescente");
            });
        }
        btnToggle.innerHTML = (modoAgrupamentoMortes === "paises") ? '<i class="bi bi-arrow-left-right"></i> Agrupar por Línguas' : '<i class="bi bi-arrow-left-right"></i> Agrupar por Países';
    }


    function ordenarDados(ordem) {
        let dadosOrdenados = [];

        if (modoAgrupamento === "paises") {
            dadosOrdenados = Object.entries(vaccStats)
                .filter(([pais, info]) => info.percentual_vacina !== undefined && info.percentual_vacina > 0);

            if (ordem === "crescente") {
                dadosOrdenados.sort((a, b) => a[1].percentual_vacina - b[1].percentual_vacina);
            } else {
                dadosOrdenados.sort((a, b) => b[1].percentual_vacina - a[1].percentual_vacina);
            }

        } else {
            let linguasStats = {};

            for (let [pais, info] of Object.entries(vaccStats)) {
                if (info.percentual_vacina !== undefined && info.vacinas) {
                    for (let lingua of info.linguas) {
                        if (!linguasStats[lingua]) {
                            linguasStats[lingua] = { populacao: 0, vacinas: 0, paises: [] };
                        }
                        linguasStats[lingua].populacao += info.populacao;
                        linguasStats[lingua].vacinas += info.vacinas;
                        linguasStats[lingua].paises.push(pais);
                    }
                }
            }

            for (let [lingua, dados] of Object.entries(linguasStats)) {
                dados.percentual_vacina = (dados.vacinas / dados.populacao) * 100;
                dadosOrdenados.push([lingua, dados]);
            }

            if (ordem === "crescente") {
                dadosOrdenados.sort((a, b) => a[1].percentual_vacina - b[1].percentual_vacina);
            } else {
                dadosOrdenados.sort((a, b) => b[1].percentual_vacina - a[1].percentual_vacina);
            }
        }

        const top10 = dadosOrdenados.slice(0, 10);
        exibirResultados(top10, ordem);
    }

    function exibirResultados(listaOrdenada, ordem) {
        const area = document.getElementById("resultados");
        const ordemTexto = ordem === "crescente" ? "Crescente (Menor para Maior)" : "Decrescente (Maior para Menor)";
        let titulo = (modoAgrupamento === "paises") ? "Top 10 Países por Vacinação" : "Top 10 Línguas por Vacinação";
        let chartTitle = (modoAgrupamento === "paises") ? "Percentual de Vacinação por País" : "Percentual de Vacinação por Língua";


        area.innerHTML = `<h4 class="mb-3 text-start">${titulo}</h4><p class="text-muted text-start">Ordem: ${ordemTexto}</p><div id="chart_div" style="width: 100%; height: 500px;"></div><div class="row row-eq-height mt-4"></div>`;
        const cardsRow = area.querySelector(".row");
        
        if (listaOrdenada.length === 0) {
            cardsRow.innerHTML = "<p>Nenhum dado encontrado.</p>";
            return;
        }

        // Desenhar o gráfico
        drawChart(listaOrdenada, chartTitle, 'percentual_vacina', 'Países/Línguas', 'Percentual de Vacinação (%)', 'green');

        listaOrdenada.forEach(([chave, info], index) => {
            const card = document.createElement("div");
            card.className = "col-xl-6 mb-4";
            
            if (modoAgrupamento === "paises") {
                card.innerHTML = `
                    <div class="card border-light-subtle shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-primary fw-bold">#${index + 1} ${chave}</h5>
                            <hr>
                            <p><i class="bi bi-people-fill text-muted"></i> <strong>População:</strong> ${info.populacao.toLocaleString('pt-BR')}</p>
                            <p><i class="bi bi-translate text-muted"></i> <strong>Línguas:</strong> ${info.linguas.join(", ")}</p>
                            <p><i class="bi bi-journal-medical text-muted"></i> <strong>Doses Aplicadas:</strong> ${info.vacinas.toLocaleString('pt-BR')}</p>
                            <div class="mt-auto">
                                <p class="fs-5"><strong>Percentual:</strong> <span class="badge bg-success p-2">${info.percentual_vacina.toFixed(2)}%</span></p>
                            </div>
                        </div>
                    </div>`;
            } else {
                card.innerHTML = `
                    <div class="card border-light-subtle shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-primary fw-bold">#${index + 1} ${chave}</h5>
                            <hr>
                            <p><i class="bi bi-people-fill text-muted"></i> <strong>População Total:</strong> ${info.populacao.toLocaleString('pt-BR')}</p>
                            <p><i class="bi bi-translate text-muted"></i> <strong>Línguas:</strong> ${chave}</p>
                            <p><i class="bi bi-journal-medical text-muted"></i> <strong>Doses Aplicadas:</strong> ${info.vacinas.toLocaleString('pt-BR')}</p>
                            <p><i class="bi bi-flag text-muted"></i> <strong>Países com esta língua:</strong> ${info.paises.join(", ")}</p>
                            <div class="mt-auto">
                                <p class="fs-5"><strong>Percentual:</strong> <span class="badge bg-success p-2">${info.percentual_vacina.toFixed(2)}%</span></p>
                            </div>
                        </div>
                    </div>`;
            }

            cardsRow.appendChild(card);
        });
    }

    function ordenarDadosMortes(ordem) {
        let dadosOrdenados = [];

        if (modoAgrupamentoMortes === "paises") {
            dadosOrdenados = Object.entries(deathStats)
                .filter(([pais, info]) => info.percentual_mortes !== undefined && info.percentual_mortes > 0);

            if (ordem === "crescente") {
                dadosOrdenados.sort((a, b) => a[1].percentual_mortes - b[1].percentual_mortes);
            } else {
                dadosOrdenados.sort((a, b) => b[1].percentual_mortes - a[1].percentual_mortes);
            }
        } else {
            let linguasStats = {};

            for (let [pais, info] of Object.entries(deathStats)) {
                if (info.percentual_mortes !== undefined && info.mortes) {
                    for (let lingua of info.linguas) {
                        if (!linguasStats[lingua]) {
                            linguasStats[lingua] = { populacao: 0, mortes: 0, paises: [] };
                        }
                        linguasStats[lingua].populacao += info.populacao;
                        linguasStats[lingua].mortes += info.mortes;
                        linguasStats[lingua].paises.push(pais);
                    }
                }
            }

            for (let [lingua, dados] of Object.entries(linguasStats)) {
                dados.percentual_mortes = (dados.mortes / dados.populacao) * 100;
                dadosOrdenados.push([lingua, dados]);
            }

            if (ordem === "crescente") {
                dadosOrdenados.sort((a, b) => a[1].percentual_mortes - b[1].percentual_mortes);
            } else {
                dadosOrdenados.sort((a, b) => b[1].percentual_mortes - a[1].percentual_mortes);
            }
        }

        const top10 = dadosOrdenados.slice(0, 10);
        exibirResultadosMortes(top10, ordem);
    }

    function exibirResultadosMortes(listaOrdenada, ordem) {
        const area = document.getElementById("resultados");
        const ordemTexto = ordem === "crescente" ? "Crescente (Menor para Maior)" : "Decrescente (Maior para Menor)";
        let titulo = (modoAgrupamentoMortes === "paises") ? "Top 10 Países por Mortalidade Covid" : "Top 10 Línguas por Mortalidade Covid";
        let chartTitle = (modoAgrupamentoMortes === "paises") ? "Percentual de Mortalidade Covid por País" : "Percentual de Mortalidade Covid por Língua";

        area.innerHTML = `<h4 class="mb-3 text-start">${titulo}</h4><p class="text-muted text-start">Ordem: ${ordemTexto}</p><div id="chart_div" style="width: 100%; height: 500px;"></div><div class="row row-eq-height mt-4"></div>`;
        const cardsRow = area.querySelector(".row");

        if (listaOrdenada.length === 0) {
            cardsRow.innerHTML = "<p>Nenhum dado encontrado.</p>";
            return;
        }

        // Desenhar o gráfico
        drawChart(listaOrdenada, chartTitle, 'percentual_mortes', 'Países/Línguas', 'Percentual de Mortalidade (%)', 'red');

        listaOrdenada.forEach(([chave, info], index) => {
            const card = document.createElement("div");
            card.className = "col-xl-6 mb-4";
            if (modoAgrupamentoMortes === "paises") {
                card.innerHTML = `
                    <div class="card border-light-subtle shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-danger fw-bold">#${index + 1} ${chave}</h5>
                            <hr>
                            <p><i class="bi bi-people-fill text-muted"></i> <strong>População:</strong> ${info.populacao.toLocaleString('pt-BR')}</p>
                            <p><i class="bi bi-translate text-muted"></i> <strong>Línguas:</strong> ${info.linguas.join(", ")}</p>
                            <p><i class="bi bi-person-x-fill text-muted"></i> <strong>Mortes:</strong> ${info.mortes.toLocaleString('pt-BR')}</p>
                            <div class="mt-auto">
                                <p class="fs-5"><strong>Percentual:</strong> <span class="badge bg-danger p-2">${info.percentual_mortes.toFixed(4)}%</span></p>
                            </div>
                        </div>
                    </div>`;
            } else {
                card.innerHTML = `
                    <div class="card border-light-subtle shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-danger fw-bold">#${index + 1} ${chave}</h5>
                            <hr>
                            <p><i class="bi bi-people-fill text-muted"></i> <strong>População Total:</strong> ${info.populacao.toLocaleString('pt-BR')}</p>
                            <p><i class="bi bi-translate text-muted"></i> <strong>Línguas:</strong> ${chave}</p>
                            <p><i class="bi bi-person-x-fill text-muted"></i> <strong>Mortes:</strong> ${info.mortes.toLocaleString('pt-BR')}</p>
                            <p><i class="bi bi-flag text-muted"></i> <strong>Países com esta língua:</strong> ${info.paises.join(", ")}</p>
                            <div class="mt-auto">
                                <p class="fs-5"><strong>Percentual:</strong> <span class="badge bg-danger p-2">${info.percentual_mortes.toFixed(4)}%</span></p>
                            </div>
                        </div>
                    </div>`;
            }
            cardsRow.appendChild(card);
        });
    }

    function drawChart(dataList, title, valueKey, hAxisTitle, vAxisTitle, barColor) {
        google.charts.setOnLoadCallback(function() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', hAxisTitle);
            data.addColumn('number', vAxisTitle);

            dataList.forEach(([chave, info]) => {
                data.addRow([chave, parseFloat(info[valueKey].toFixed(2))]);
            });

            const options = {
                title: title,
                hAxis: {
                    title: hAxisTitle,
                    titleTextStyle: { color: '#333' },
                    slantedText: true,
                    slantedTextAngle: 90 // Labels verticais
                },
                vAxis: {
                    minValue: 0,
                    title: vAxisTitle
                },
                legend: { position: 'none' },
                colors: [barColor],
                chartArea: { left: '10%', width: '70%', height: '65%', top: 60, bottom: 120 } // aumenta espaço embaixo
            };

            const chartDiv = document.getElementById('chart_div');
            chartDiv.style.paddingBottom = "40px"; // padding extra para as labels
            chartDiv.style.minHeight = "500px"; // garante altura mínima

            const chart = new google.visualization.ColumnChart(chartDiv);
            chart.draw(data, options);
        });
    }
</script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>